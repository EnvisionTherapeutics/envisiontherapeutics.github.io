<!DOCTYPE HTML>
<html>
<head>
	<title>Reset Password - Envision Therapeutics</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:wght@400;600;700&display=swap" rel="stylesheet">
	<style>
		* {
			box-sizing: border-box;
		}
		body {
			font-family: 'Source Serif 4', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, serif;
			margin: 0;
			padding: 20px;
			min-height: 100vh;
			background: #F2F0E7;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.wrapper {
			width: 100%;
			max-width: 500px;
		}
		.container {
			background: #FFFFFF;
			padding: 40px 34px;
			border-radius: 12px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.08);
			width: 100%;
		}
		h1 {
			font-family: 'Source Serif 4', serif;
			font-size: 24px;
			font-weight: 600;
			color: #1A1A1A;
			margin-top: 0;
			margin-bottom: 10px;
		}
		.description {
			font-size: 14px;
			color: #757575;
			margin-bottom: 24px;
			line-height: 20px;
		}
		.form-group {
			margin-bottom: 14px;
		}
		label {
			display: block;
			margin-bottom: 5px;
			color: #757575;
			font-weight: 500;
			font-size: 16px;
		}
		input {
			width: 100%;
			padding: 10px 16px;
			border: 1px solid #E8E8E8;
			border-radius: 9999px;
			font-size: 16px;
			font-family: inherit;
			background: #FFFFFF;
			color: #1A1A1A;
			transition: border-color 0.2s;
		}
		input:focus {
			outline: none;
			border-color: #C4906B;
		}
		input::placeholder {
			color: #BDBDBD;
		}
		.password-instructions {
			font-size: 12px;
			color: #757575;
			margin-top: 4px;
			margin-bottom: 16px;
			line-height: 16px;
		}
		button {
			width: 100%;
			height: 42px;
			padding: 10px;
			background: #C4906B;
			color: #FFFFFF;
			border: 2px solid #C4906B;
			border-radius: 9999px;
			font-size: 16px;
			font-weight: 600;
			font-family: inherit;
			cursor: pointer;
			transition: background-color 0.2s, border-color 0.2s;
			margin-top: 10px;
		}
		button:hover:not(:disabled) {
			background: #C17A5C;
			border-color: #C17A5C;
		}
		button:disabled {
			background: #F5F5F5;
			border-color: #E8E8E8;
			color: #999999;
			cursor: not-allowed;
		}
		.message {
			padding: 12px 16px;
			border-radius: 8px;
			margin-bottom: 20px;
			display: none;
			font-size: 14px;
			line-height: 20px;
		}
		.message.success {
			background: #E8F5E9;
			color: #2E7D32;
			border: 1px solid #4CAF50;
		}
		.message.error {
			background: #FFEBEE;
			color: #C62828;
			border: 1px solid #EF5350;
		}
		.error-text {
			font-size: 12px;
			color: #C62828;
			margin-top: 4px;
			display: none;
		}
		.loading {
			text-align: center;
			color: #757575;
			padding: 20px;
		}
	</style>
</head>
<body>
	<div class="wrapper">
		<div class="container">
			<h1>Reset Your Password</h1>
			<p class="description" id="description">Please enter your new password below.</p>
			<div id="message" class="message"></div>
			<div id="loading" class="loading" style="display: none;">Verifying reset link...</div>
			<div id="noTokenMessage">
				<div style="color: #C62828; margin-bottom: 16px; font-size: 14px; line-height: 20px;">
					<strong>No password reset link found.</strong>
				</div>
				<p style="font-size: 14px; color: #757575; margin-bottom: 12px; line-height: 20px;">
					Please request a password reset from the Envision app:
				</p>
				<ol style="font-size: 14px; color: #757575; padding-left: 20px; margin-top: 8px; line-height: 24px;">
					<li>Open the Envision app</li>
					<li>Go to the "Forgot Password" screen</li>
					<li>Enter your email address</li>
					<li>Check your email for the reset link</li>
					<li>Click the link to open this page</li>
				</ol>
			</div>
			<form id="resetForm" style="display: none;">
			<div class="form-group">
				<label for="password">New Password</label>
				<input type="password" id="password" name="password" required minlength="6" autocomplete="new-password" placeholder="Enter new password">
				<div id="passwordError" class="error-text"></div>
			</div>
			<div class="form-group">
				<label for="confirmPassword">Confirm New Password</label>
				<input type="password" id="confirmPassword" name="confirmPassword" required minlength="6" autocomplete="new-password" placeholder="Confirm new password">
				<div id="confirmPasswordError" class="error-text"></div>
			</div>
			<p class="password-instructions">Password must be at least 6 characters long.</p>
			<button type="submit" id="submitBtn">Reset Password</button>
		</form>
		</div>
	</div>

	<!-- Supabase Client Library -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script>
		// Supabase Configuration
		// Replace these with your actual Supabase credentials from Supabase Dashboard → Settings → API
		// The anon key is safe to expose in client-side code (it's designed for this)
		const SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE'; // e.g., 'https://your-project-id.supabase.co'
		const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE'; // The 'anon' or 'public' key

		// Debug: Log configuration status (safe to expose - these are public keys)
		// Run in console: window.debugSupabaseConfig()
		window.debugSupabaseConfig = function() {
			console.log('=== Supabase Configuration Debug ===');
			console.log('SUPABASE_URL:', SUPABASE_URL);
			console.log('SUPABASE_ANON_KEY:', SUPABASE_ANON_KEY ? SUPABASE_ANON_KEY.substring(0, 20) + '...' : 'NOT SET');
			console.log('URL looks valid:', SUPABASE_URL && SUPABASE_URL.includes('https://') && SUPABASE_URL.length > 20);
			console.log('Key looks valid:', SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.startsWith('eyJ') && SUPABASE_ANON_KEY.length > 50);
			console.log('Supabase library loaded:', !!(window.supabase && window.supabase.createClient));
			console.log('supabaseClient initialized:', !!supabaseClient);
			console.log('====================================');
			return {
				url: SUPABASE_URL,
				urlLooksValid: SUPABASE_URL && SUPABASE_URL.includes('https://') && SUPABASE_URL.length > 20,
				keyLooksValid: SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.startsWith('eyJ') && SUPABASE_ANON_KEY.length > 50,
				supabaseLibLoaded: !!(window.supabase && window.supabase.createClient),
				clientInitialized: !!supabaseClient
			};
		};

		// Initialize Supabase client function (called after CDN loads)
		// Use window.supabase to access the global from CDN, avoid redeclaring
		let supabaseClient = null;
		function initializeSupabaseClient() {
			console.log('initializeSupabaseClient() called');
			console.log('SUPABASE_URL full:', SUPABASE_URL);
			console.log('SUPABASE_ANON_KEY full:', SUPABASE_ANON_KEY);
			console.log('URL length:', SUPABASE_URL ? SUPABASE_URL.length : 0);
			console.log('Key length:', SUPABASE_ANON_KEY ? SUPABASE_ANON_KEY.length : 0);
			console.log('URL includes https:', SUPABASE_URL && SUPABASE_URL.includes('https://'));
			console.log('Key starts with eyJ:', SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.startsWith('eyJ'));
			console.log('window.supabase exists:', !!window.supabase);
			console.log('window.supabase.createClient exists:', !!(window.supabase && window.supabase.createClient));
			
			// Check credentials are configured - use positive validation (check if values look valid)
			// Don't compare to placeholder strings - sed replaces those during build!
			const urlLooksValid = SUPABASE_URL && SUPABASE_URL.includes('https://') && SUPABASE_URL.length > 20;
			const keyLooksValid = SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.startsWith('eyJ') && SUPABASE_ANON_KEY.length > 50;
			
			console.log('Validation check:', {
				urlLooksValid,
				keyLooksValid,
				urlHasHttps: SUPABASE_URL && SUPABASE_URL.includes('https://'),
				urlLength: SUPABASE_URL ? SUPABASE_URL.length : 0,
				keyStartsWithEyJ: SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.startsWith('eyJ'),
				keyLength: SUPABASE_ANON_KEY ? SUPABASE_ANON_KEY.length : 0
			});
			
			if (!urlLooksValid || !keyLooksValid) {
				console.log('❌ Credentials are invalid');
				return false;
			}
			
			// Check CDN library is loaded
			if (!window.supabase || !window.supabase.createClient) {
				console.log('❌ Supabase CDN library not loaded');
				return false;
			}
			
			// Initialize client
			try {
				supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
				console.log('✅ Supabase client initialized successfully');
				return true;
			} catch (e) {
				console.error('❌ Error initializing Supabase client:', e);
				return false;
			}
		}

		// Get form elements
		const form = document.getElementById('resetForm');
		const messageDiv = document.getElementById('message');
		const loadingDiv = document.getElementById('loading');
		const noTokenMessage = document.getElementById('noTokenMessage');
		const description = document.getElementById('description');
		const submitBtn = document.getElementById('submitBtn');
		const passwordInput = document.getElementById('password');
		const confirmPasswordInput = document.getElementById('confirmPassword');
		const passwordError = document.getElementById('passwordError');
		const confirmPasswordError = document.getElementById('confirmPasswordError');

		// Extract tokens from URL
		// Supabase sends tokens in URL hash (fragment): #access_token=...&refresh_token=...&type=recovery
		// Or errors: #error=access_denied&error_code=otp_expired&error_description=...
		function extractTokensFromUrl() {
			// First check URL hash (Supabase's standard format)
			const hash = window.location.hash;
			
			// Debug logging
			console.log('extractTokensFromUrl - hash:', hash ? hash.substring(0, 100) + '...' : 'empty');
			
			if (hash && hash.length > 1) {
				const hashParams = hash.substring(1); // Remove the #
				
				try {
					const params = new URLSearchParams(hashParams);
					
					// Check for error parameters first
					const error = params.get('error');
					if (error) {
						console.log('Found error in URL:', error);
						const errorCode = params.get('error_code');
						const errorDescription = params.get('error_description');
						return {
							error: error,
							error_code: errorCode,
							error_description: errorDescription,
							access_token: null,
							refresh_token: null,
							type: null
						};
					}
					
					// Check for access token
					const accessToken = params.get('access_token');
					const refreshToken = params.get('refresh_token');
					const type = params.get('type');
					
					console.log('Token extraction:', {
						hasAccessToken: !!accessToken,
						hasRefreshToken: !!refreshToken,
						type: type
					});
					
					if (accessToken) {
						return { 
							access_token: accessToken, 
							refresh_token: refreshToken, 
							type: type 
						};
					}
				} catch (e) {
					console.error('Error parsing hash:', e);
					// Error parsing hash, continue to fallback
				}
			}
			
			// Fallback: check query params (some email clients might convert hash to query)
			const queryParams = new URLSearchParams(window.location.search);
			const queryError = queryParams.get('error');
			if (queryError) {
				return {
					error: queryError,
					error_code: queryParams.get('error_code'),
					error_description: queryParams.get('error_description'),
					access_token: null,
					refresh_token: null,
					type: null
				};
			}
			
			const queryToken = queryParams.get('access_token');
			if (queryToken) {
				return {
					access_token: queryToken,
					refresh_token: queryParams.get('refresh_token'),
					type: queryParams.get('type')
				};
			}
			
			// No tokens found
			return { access_token: null, refresh_token: null, type: null };
		}

		function showMessage(text, isError) {
			messageDiv.textContent = text;
			messageDiv.className = 'message ' + (isError ? 'error' : 'success');
			messageDiv.style.display = 'block';
			messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
		}

		function showFieldError(field, message) {
			const errorDiv = field === 'password' ? passwordError : confirmPasswordError;
			const input = field === 'password' ? passwordInput : confirmPasswordInput;
			if (message) {
				errorDiv.textContent = message;
				errorDiv.style.display = 'block';
				input.style.borderColor = '#EF5350';
			} else {
				errorDiv.style.display = 'none';
				input.style.borderColor = '#E8E8E8';
			}
		}

		function validateForm() {
			const password = passwordInput.value;
			const confirmPassword = confirmPasswordInput.value;
			let isValid = true;

			showFieldError('password', '');
			showFieldError('confirmPassword', '');

			if (password.length < 6) {
				showFieldError('password', 'Password must be at least 6 characters');
				isValid = false;
			}

			if (password !== confirmPassword) {
				showFieldError('confirmPassword', 'Passwords do not match');
				isValid = false;
			}

			return isValid;
		}

		// Real-time validation
		passwordInput.addEventListener('input', () => {
			if (passwordInput.value.length > 0) {
				validateForm();
			} else {
				showFieldError('password', '');
			}
		});

		confirmPasswordInput.addEventListener('input', () => {
			if (confirmPasswordInput.value.length > 0) {
				validateForm();
			} else {
				showFieldError('confirmPassword', '');
			}
		});

		// Initialize on page load
		async function init() {
			// Wait a tiny bit to ensure hash is available (some browsers need this)
			if (!window.location.hash && document.readyState === 'complete') {
				// Hash might not be set yet, wait a moment
				await new Promise(resolve => setTimeout(resolve, 50));
			}
			
			const tokens = extractTokensFromUrl();
			console.log('init() - extracted tokens:', {
				hasAccessToken: !!tokens.access_token,
				hasError: !!tokens.error,
				type: tokens.type
			});
			
			// Handle error parameters (expired/invalid links)
			if (tokens.error) {
				let errorMessage = 'This password reset link has expired or is invalid. Please request a new one.';
				if (tokens.error_description) {
					errorMessage = decodeURIComponent(tokens.error_description.replace(/\+/g, ' '));
				}
				showMessage(errorMessage, true);
				description.style.display = 'none';
				form.style.display = 'none';
				loadingDiv.style.display = 'none';
				noTokenMessage.style.display = 'none';
				return;
			}
			
			// If no token, show helpful message immediately
			if (!tokens.access_token) {
				description.style.display = 'none';
				form.style.display = 'none';
				loadingDiv.style.display = 'none';
				noTokenMessage.style.display = 'block';
				return;
			}
			
			// Hide no-token message if we have a token
			noTokenMessage.style.display = 'none';
			description.style.display = 'block';

			// Initialize Supabase client (wait for CDN if needed)
			// Try to initialize immediately
			console.log('Attempting to initialize Supabase client...');
			if (!initializeSupabaseClient()) {
				console.log('First attempt failed, waiting for CDN...');
				// CDN might not be loaded yet, wait a bit and try again
				await new Promise(resolve => setTimeout(resolve, 100));
				console.log('Retrying Supabase client initialization...');
				if (!initializeSupabaseClient()) {
					console.log('Second attempt also failed');
					// Still failed - check if it's credentials or library
					// Use positive validation (don't compare to placeholders - sed replaces those!)
					const urlLooksValid = SUPABASE_URL && SUPABASE_URL.includes('https://') && SUPABASE_URL.length > 20;
					const keyLooksValid = SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.startsWith('eyJ') && SUPABASE_ANON_KEY.length > 50;
					console.log('Final check - URL valid:', urlLooksValid, 'Key valid:', keyLooksValid);
					console.log('URL value:', SUPABASE_URL);
					console.log('Key value:', SUPABASE_ANON_KEY ? SUPABASE_ANON_KEY.substring(0, 30) + '...' : 'NOT SET');
					
					if (!urlLooksValid || !keyLooksValid) {
						showMessage('Password reset page is not configured. Supabase credentials need to be set via GitHub Secrets.', true);
					} else {
						showMessage('Failed to load Supabase library. Please refresh the page.', true);
					}
					description.style.display = 'none';
					form.style.display = 'none';
					loadingDiv.style.display = 'none';
					noTokenMessage.style.display = 'none';
					return;
				}
			}
			console.log('Supabase client initialized, continuing...');

			// Check if this is a password recovery type
			if (tokens.type !== 'recovery') {
				showMessage('Invalid reset link type. Please request a new password reset.', true);
				return;
			}

			loadingDiv.style.display = 'block';

			try {
				// Set session with tokens from email
				// Refresh token is required for password reset flow
				if (!tokens.refresh_token) {
					throw new Error('Invalid reset link: missing refresh token. Please request a new password reset.');
				}

				const { data, error } = await supabaseClient.auth.setSession({
					access_token: tokens.access_token,
					refresh_token: tokens.refresh_token
				});

				if (error) {
					throw error;
				}

				if (!data.session || !data.user) {
					throw new Error('Failed to establish session');
				}

				// Session established successfully, show form
				loadingDiv.style.display = 'none';
				form.style.display = 'block';

			} catch (error) {
				loadingDiv.style.display = 'none';
				let errorMessage = 'Invalid or expired reset link. Please request a new password reset.';
				
				// Provide more specific error messages
				if (error.message) {
					if (error.message.includes('expired') || error.message.includes('invalid')) {
						errorMessage = 'This password reset link has expired or is invalid. Please request a new one.';
					} else if (error.message.includes('refresh token')) {
						errorMessage = error.message;
					} else {
						errorMessage = error.message;
					}
				}
				
				showMessage(errorMessage, true);
			}
		}

		// Handle form submission
		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			
			messageDiv.style.display = 'none';

			if (!validateForm()) {
				return;
			}

			const password = passwordInput.value;

			submitBtn.disabled = true;
			submitBtn.textContent = 'Resetting...';

			try {
				// Update password using Supabase client
				const { data, error } = await supabaseClient.auth.updateUser({
					password: password
				});

				if (error) {
					throw error;
				}

				showMessage('Password reset successfully! You can now sign in with your new password.', false);
				form.style.display = 'none';
				
				// Optionally redirect to sign-in page after a delay
				setTimeout(() => {
					window.location.href = '/';
				}, 3000);

			} catch (error) {
				showMessage(error.message || 'Failed to reset password. Please try again.', true);
				submitBtn.disabled = false;
				submitBtn.textContent = 'Reset Password';
			}
		});

		// Initialize when page loads
		// Use a small delay to ensure hash is available
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', () => {
				setTimeout(init, 50);
			});
		} else {
			// Page already loaded, but hash might not be processed yet
			setTimeout(init, 50);
		}
	</script>
</body>
</html>
